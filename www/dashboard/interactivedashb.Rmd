---
title: "interactivedashboard"
author: "david"
output: html_document
---

```{r, echo = F, message=FALSE}
library(shiny)
library(shinyWidgets)
library(jsonlite)


modelchart <- fromJSON('www/modelcharact.json')
modelchartT <- fromJSON(modelchart)
structurechoices <- unique(modelchartT$Structure)
neuronschoices <- unique(modelchartT$Neurons)
inputschoices <- unique(modelchartT$Inputs)
scalechoices <- unique(modelchartT$Scale)
transchoices <- unique(modelchartT$Transformation)
setchoices <- unique(modelchartT$Set)
modelchoices <- unique(modelchartT$Model)
modelslosesdir <- fromJSON('www/modelsloss.json')
modelsloses <- fromJSON(modelslosesdir)
optimalmodel <- which(modelsloses['RMSE',] == min(modelsloses['RMSE',]))
optimalmodel <- names(modelsloses[,optimalmodel,drop = F])
optimalmodel <- gsub("model","",optimalmodel)
predtrueval <- fromJSON('www/realvalues.json') 

HTML("
     <style>
     .author,.title{
        display: none;
     }
     .main-container{
        max-width: 100%;
        margin-left:auto;
        margin-right:auto;
        margin-top:1%;
     }
     #pickmlcontain div{
        margin:auto;
     }
     .cursor-default{
        cursor: default;
     }
     #pickmlcontain > div.form-group{
        margin-right: 0;
     }
     #infoicon{
       cursor: pointer;
     }
     #containinginfot tr{
       border: thin solid black;
     }
     #containinginfot th{
       border: thin solid black;
       padding: 3px; 
     }
     #containinginfot td{
       border: thin solid black;
       padding: 3px;
       text-align: center;
     }
     #lossestable table{
      height: 100%;
      width: 100%;
     }
     #lossestable tr{
      border: thin solid black;
     }
     #lossestable th{
      border: thin solid black;
      padding: 4px;
     }
     #lossestable td{
      border: thin solid black;
      padding: 4px;
      text-align: center;
     }
     #lossestable th:hover{
      cursor: pointer;
      background-color: lightgrey;
     }
     #collapseSB:hover{
      cursor: pointer;
     }
     </style>
     <script src='www/plotly-latest.min.js'></script>
     ")

#Panel
sidebarLayout(
  sidebarPanel(
    div(
      id = 'SBchild',
      div(
        icon('caret-square-o-left', style = "font-size: 28px;", id = "collapseSB"),
        style = "margin-bottom: 2%; float:right;"
      ),
      style = "display: flow-root;"
    ),
    div(
      id = 'emptydiv',
      style = "height:0;"),
    div(
      id = 'containingfilters',
      div(tags$b("Filters:")),
      div(style = "height:1%"),
      pickerInput(
        inputId = "setpick",
        label = "Sets",
        choices = setchoices,
        selected = setchoices,
        multiple = T,
        options = pickerOptions(
          style = "btn-default",
          size = 3,
          `live-search` = T)),
      pickerInput(
        inputId = "transfpick",
        label = "Transformations",
        choices = transchoices,
        selected = transchoices,
        multiple = T,
        options = pickerOptions(
          style = "btn-default"
          )),
      pickerInput(
        inputId = "scalespick",
        label = "Scales",
        choices = scalechoices,
        selected = scalechoices,
        multiple = T,
        options = pickerOptions(
          style = "btn-default"
          )),
      pickerInput(
        inputId = "inputspick",
        label = "Inputs",
        choices = inputschoices,
        selected = inputschoices,
        multiple = T,
        options = pickerOptions(
          style = "btn-default",
          size = 3,
          `live-search` = T)),
      div(
        style="border: thin solid black; padding: 5%;",
        materialSwitch(
          inputId = "structorneu",
          label = tags$b("Structure or Neurons"),
          status = "primary"),
        div(
          style = "display: flex; justify-content: space-between;",
          pickerInput(
            inputId = "structurepick",
            label = "Structure",
            choices = structurechoices,
            selected = structurechoices,
            multiple = T,
            options = pickerOptions(
              style = "btn-default",
              size = 3,
              `live-search` = T),
            width = "48%"),
          pickerInput(
            inputId = "neuronspick",
            label = "Neurons",
            choices = neuronschoices,
            selected = neuronschoices,
            multiple = T,
            options = pickerOptions(
              style = "btn-default",
              size = 3,
              `live-search` = T),
            width = "48%")
          )
        ),
      div(style = "height:1em"),
      pickerInput(
        inputId = "modelpick",
        label = "Models",
        choices = modelchoices,
        selected = modelchoices,
        multiple = T,
        options = pickerOptions(
          style = "btn-default",
          size = 3,
          `live-search` = T))
      ),
    style = "border: thin solid black; background-color:white; border-radius: 0"
  ),
  mainPanel(
    wellPanel(
      div(
        div(
          id = "pickmlcontain",
          pickerInput(
            inputId = "plotmodelpick",
            label = "Model",
            choices = modelchoices,
            selected = optimalmodel,
            width = "35%",
            options = pickerOptions(
              style = "btn-default",
              size = 3,
              `live-search` = T)),
          div(
            id = "infoicon",
            icon('info'),
            style = 'margin-left: 0; border: thin solid black; padding: 0.10% 1.25% 0.10% 1.25%;border-radius: 49%;'),
          style = "text-align:center;display: flex;"),
        div(
          id = "moduleinfo",
          div(
            id = "containinginfot"
          ),
          style = "border: thin solid black;
                   z-index: 1;
                   right: 10%;
                   top: 8%;
                   position: absolute;
                   box-shadow: 6px 5px lightgrey;
                   background-color: white;
                   padding: 2%;
                   display: none"
          )
      ),
      div(
        style = "height:10px"
      ),
      div(
        div(
          id = "predictionsplot",
          style = "width: 61%; resize:both"
        ),
        div(
          id = "trainingplot",
          style = "width: 35%; resize:both"
        ),
        style ="height:280px;display: flex;justify-content: space-between;"
      ),
      div(
        style = "height:10px"
      ),
      div(
        div(
          id = "resultsplot",
          div(
            div(
              actionButton(
                inputId = "leftbut",
                label = "",
                icon = icon("chevron-left")),
              style = "width: 10%; margin: auto; text-align: center;"
            ),
            div(
              id = "barchartloss",
              style = "width: 80%"
            ),
            div(
              actionButton(
                inputId = "rightbut",
                label = "",
                icon = icon("chevron-right")),
              style = "width: 10%; margin: auto; text-align: center;"
            ),
            style = "width: 80%; display: flex; flex-wrap: nowrap"
          ),
          div(
            div(
              div(style = "height:30%"),
              actionButton(
                inputId = "totable",
                label = "",
                icon = icon("table")),
              div(style = "height: 10%"),
              pickerInput(
                inputId = "errorpick",
                label = "Error",
                choices = c("MSE","RMSE","MAE"),
                selected = "RMSE",
                options = pickerOptions(
                  style = "btn-default",
                  size = 3)
                ),
              style = 'width: 50%;'
            ),
            div(
              HTML("
            <label for = 'rangemodel' class = 'form-label' style = 'height: 10%'>Model:</label>
            <div style = 'height: 90%; display: flex; flex-wrap: nowrap'>
              <div style = 'width: 50%'>
                 <div><b>max:</b></div>
                 <div><b id = 'maxvalue'>10</b></div>
                 <div style = 'height:29%'></div>
                 <div><b id = 'actualvalue'></b></div>
                 <div style = 'height:29%'></div>
                 <div><b>min:</b></div>
                 <div><b id = 'minvalue'>1</b></div>
              </div>
              <input id = 'rangemodel' type = 'range' min = '1' max = '10' step = '1' style = '-webkit-appearance: slider-vertical; height: 100%; width: 50%' orient = 'vertical'></input>
            </div>
                 ")
            ),
            style = "width: 20%; display: flex; flex-wrap: nowrap"
          ),
          style = "height:280px; display: flex; flex-wrap: nowrap"
        ),
        div(
          id = "resultstable",
          div(
            id = "lossestable",
            style = "width: 95%;overflow: auto; margin: 2%;"
          ),
          div(
            div(
              style = "height: 30%;"
            ),
            actionButton(
                inputId = "tochart",
                label = "",
                icon = icon("chart-bar")),
            div(
              style = "height: 10%;"
            ),
            actionButton(
                inputId = "transpondtable",
                label = "",
                icon = icon('sync')),
            style = "width: 5%; display: flex; flex-direction: column;"
          ),
          style = "height:280px"
        )
      ),
      style = "border: thin solid black; background-color:white; border-radius: 0"
    )
  )
)

#Disable neuronspick as default
HTML(paste0(
  "
<script>
  function disableneu(){
    
    document.querySelector('#neuronspick + button').setAttribute('disabled','');
  
  };
  function mydisablefunc(id){
     document.querySelector('#'+id).setAttribute('disabled','');
  };
  function myenablefunc(id){
     document.querySelector('#'+id).removeAttribute('disabled');
  };
  function hidefunc(id){
    var x = document.querySelector('#'+id);
    x.style.display = 'none';
  };
  function showfunc(id){
    var x = document.querySelector('#'+id);
    x.stlye.display = 'block';
  };
  
  var ERRORS = ",modelslosesdir,";
  var ARROWS = 0;
  
  function mybarplotlossfunc(){
    if($('#errorpick').val() == 'MSE'){
      var errors = ERRORS[0];
    }else{
      if($('#errorpick').val() == 'RMSE'){
        var errors = ERRORS[1];
      }else{
        var errors = ERRORS[2];
      };
    };
    var pickedmodels = $('#modelpick').val();
    var modelslosses = [];
    for(var models = 0; models < pickedmodels.length; models++){
      var model = 'model'+ pickedmodels[models];
      var ismodel = model in errors;
      if(ismodel == true){
        obj = {model : model, value: errors[model]}
        modelslosses.push(obj);
      }else{};
    };
    var sortederrors = modelslosses.sort((a,b) => a.value - b.value);
    var modelrange = document.querySelector('#rangemodel');
    var endslice = ARROWS + parseInt(modelrange.value);
    var slicederrors = [];
    for( piece = ARROWS; piece < endslice; piece++){
      slicederrors.push(sortederrors[piece]);
    };
    var x = getCol(slicederrors, 'model');
    var y = getCol(slicederrors, 'value');
    
    var data = [{
       x: x,
       y: y,
       type: 'bar'
    }];
    
    var layoutlossplot = {
        margin: {
          b: 40,
          l: 60,
          t: 25,
          r: 10},
        xaxis:{
          tickformat: ',d',
          nticks: 10,
          showgrid: true,
          linecolor: 'black',
          ticks: 'outside'
        },
        yaxis: {
          domain: [0, 1],
          automargin: true,
          title: $('#errorpick').val(),
          showgrid: true,
          linecolor: 'black',
          rangemode: 'normal',
          ticks: 'outside'
        },
        hovermode: 'x unified',
        dragmode: true
    };
    var config = {
      modeBarButtonsToRemove:['zoom2d','pan2d','select2d','lasso2d','zoomIn2d','zoomOut2d','autoScale2d','resetScale2d'],
      responsive:true
    }
    
    Plotly.plot('barchartloss',data,layoutlossplot,config);
  };
  
  $(window).on('load',function(){
    disableneu();
    hidefunc('resultstable');
    amountofmodels = Object.keys(ERRORS[0]).length - 1;
    document.querySelector('#rangemodel').setAttribute('max',amountofmodels);
    document.querySelector('#maxvalue').innerHTML = amountofmodels;
    var modelrange = document.querySelector('#rangemodel');
    if(amountofmodels < 5){
       modelrange.value = amountofmodels;
       mydisablefunc('leftbut');
       mydisablefunc('rightbut')
    }else{
       modelrange.value = 5;
       mydisablefunc('leftbut');
    };
    document.querySelector('#actualvalue').innerHTML = modelrange.value;
    mybarplotlossfunc();
    var cursorel = document.querySelector('#barchartloss .plotly .main-svg  .draglayer');
    cursorel.classList.add('cursor-default');
    cursorel.classList.remove('cursor-crosshair');
    
  });
</script>"
))

#To do on structure or neurons change
tags$script(
  "$('#structorneu').on('change', function(){
  var StrucOrNeu = document.getElementById('structorneu');
  var Struc = document.querySelector('#structurepick + button');
  var Neu = document.querySelector('#neuronspick + button');
  if(StrucOrNeu.checked == true){
      Neu.removeAttribute('disabled');
      Struc.setAttribute('disabled','');
  }else{
      Neu.setAttribute('disabled','');
      Struc.removeAttribute('disabled');
  }
  })
  "
)

#Action when filters clicked
HTML(paste0("<script>
var datamodel = ",modelchart,";

function getCol(data, col){
   var column = [];
   for(var i = 0; i < data.length; i++){
      column.push(data[i][col]);
   }
   return column;
}


function getAllindex(arr,val){
   var indexes = [], i =-1;
   for(var a =0; a < val.length; a++){
      while((i = arr.indexOf(val[a], i+1)) != -1){
       indexes.push(i);
      }
      
   }
   var sortedindexes = indexes.sort((a,b) => a-b);
   return sortedindexes;
}

function selectrows(data,rows){
 var newdata = [];
 for(var i = 0; i < rows.length; i++){
    var r = rows[i];
    newdata.push(data[r]);
 }
 return newdata;
}

function filterdata(data, set, trans, scale, inps, stn, struct, neur){
   var setcol = getCol(data, 'Set');
   var whichset = getAllindex(setcol, set);
   var filterset = selectrows(data,whichset);
   
   var transcol = getCol(filterset, 'Transformation');
   var whichtrans = getAllindex(transcol, trans);
   var filtertrans = selectrows(filterset, whichtrans);
   
   var scalecol = getCol(filtertrans, 'Scale');
   var whichsca = getAllindex(scalecol, scale);
   var filtersca = selectrows(filtertrans, whichsca);
   
   var inpscol = getCol(filtersca, 'Inputs');
   var whichinps = getAllindex(inpscol, inps);
   var filterinp = selectrows(filtersca,whichinps);
   
   if(stn == false){
      var strucol = getCol(filterinp,'Structure');
      var whichstruc = getAllindex(strucol, struct);
      var filterdata = selectrows(filterinp,whichstruc);
   }else{
      var neucol = getCol(filterinp,'Neurons');
      var neucols = neucol.map(String);
      var whichneu = getAllindex(neucols, neur);
      var filterdata = selectrows(filterinp, whichneu);
   }
   return filterdata;
}

$('#setpick').on('change', function(){
  var StrucOrNeu = document.getElementById('structorneu');
  var filtereddata = filterdata(datamodel, $('#setpick').val(), $('#transfpick').val(), $('#scalespick').val(), $('#inputspick').val(), StrucOrNeu.checked, $('#structurepick').val(), $('#neuronspick').val())
  var Modelcolumn = getCol(filtereddata,'Model');
  var uniquemodelcol = [...new Set(Modelcolumn)];
  $('#modelpick').selectpicker('val',uniquemodelcol);
});

$('#transfpick').on('change', function(){
  var StrucOrNeu = document.getElementById('structorneu');
  var filtereddata = filterdata(datamodel, $('#setpick').val(), $('#transfpick').val(), $('#scalespick').val(), $('#inputspick').val(), StrucOrNeu.checked, $('#structurepick').val(), $('#neuronspick').val())
  var Modelcolumn = getCol(filtereddata,'Model');
  var uniquemodelcol = [...new Set(Modelcolumn)];
  $('#modelpick').selectpicker('val',uniquemodelcol);
});

$('#scalespick').on('change', function(){
  var StrucOrNeu = document.getElementById('structorneu');
  var filtereddata = filterdata(datamodel, $('#setpick').val(), $('#transfpick').val(), $('#scalespick').val(), $('#inputspick').val(), StrucOrNeu.checked, $('#structurepick').val(), $('#neuronspick').val())
  var Modelcolumn = getCol(filtereddata,'Model');
  var uniquemodelcol = [...new Set(Modelcolumn)];
  $('#modelpick').selectpicker('val',uniquemodelcol);
});

$('#inputspick').on('change', function(){
  var StrucOrNeu = document.getElementById('structorneu');
  var filtereddata = filterdata(datamodel, $('#setpick').val(), $('#transfpick').val(), $('#scalespick').val(), $('#inputspick').val(), StrucOrNeu.checked, $('#structurepick').val(), $('#neuronspick').val())
  var Modelcolumn = getCol(filtereddata,'Model');
  var uniquemodelcol = [...new Set(Modelcolumn)];
  $('#modelpick').selectpicker('val',uniquemodelcol);
});

$('#structurepick').on('change', function(){
  var StrucOrNeu = document.getElementById('structorneu');
  var filtereddata = filterdata(datamodel, $('#setpick').val(), $('#transfpick').val(), $('#scalespick').val(), $('#inputspick').val(), StrucOrNeu.checked, $('#structurepick').val(), $('#neuronspick').val())
  var Modelcolumn = getCol(filtereddata,'Model');
  var uniquemodelcol = [...new Set(Modelcolumn)];
  $('#modelpick').selectpicker('val',uniquemodelcol);
  var neuronscolumn = getCol(filtereddata,'Neurons');
  var uniqueneucol = [...new Set(neuronscolumn)];
  $('#neuronspick').selectpicker('val',uniqueneucol);
  
});

$('#neuronspick').on('change', function(){
  var StrucOrNeu = document.getElementById('structorneu');
  var filtereddata = filterdata(datamodel, $('#setpick').val(), $('#transfpick').val(), $('#scalespick').val(), $('#inputspick').val(), StrucOrNeu.checked, $('#structurepick').val(), $('#neuronspick').val())
  var Modelcolumn = getCol(filtereddata,'Model');
  var uniquemodelcol = [...new Set(Modelcolumn)];
  $('#modelpick').selectpicker('val',uniquemodelcol);
  var structcolumn = getCol(filtereddata,'Structure');
  var uniquestrucol = [...new Set(structcolumn)];
  $('#structurepick').selectpicker('val',uniquestrucol);
  
});
            </script>"))

#On model change update bestmodel plots
HTML(paste0("
<script>

function getMin(data, value, val){
  var result = data[1]['model'+ value] - data[1]['model'+val]
  
  if(result >= 0){
    var x = val;
  }else{
    var x = value;
  }
  
  return x;
}

$('#modelpick').on('changed.bs.select',function(){
  $('#plotmodelpick').empty();
  var newchoices = $('#modelpick').val();
  var losses = ",modelslosesdir,";
  
  for(var i =0; i < newchoices.length; i++){
      
      $('#plotmodelpick').append('<option value=",'"',"'",'+newchoices[i]+',"'",'"',">'+newchoices[i]+'</option>');
      
      if(i == 1){
        var minval = getMin(losses, newchoices[0],newchoices[1])
      }else{
        var minval = getMin(losses, minval, newchoices[i])
      }
      
   }
  
  $('#plotmodelpick').selectpicker('val',minval);
  $('#plotmodelpick').selectpicker('refresh');
  
})
</script>"))

#On windows resize
HTML(
  paste0("
<script>
  let observer = new MutationObserver(function(mutations){
     window.dispatchEvent(new Event('resize'));
  });
  let PLOTPRED = document.getElementById('predictionsplot');
  observer.observe(PLOTPRED,{
     attributes: true
  });
  let TRAINLOSS =  document.getElementById('trainingplot');
  observer.observe(TRAINLOSS,{
     attributes: true
  });
  
  window.onresize = function(){
     var cursorel = document.querySelector('#predictionsplot .plotly .main-svg  .draglayer');
     cursorel.classList.add('cursor-default');
     cursorel.classList.remove('cursor-crosshair');
     var cursorel = document.querySelector('#barchartloss .plotly .main-svg  .draglayer');
     cursorel.classList.add('cursor-default');
     cursorel.classList.remove('cursor-crosshair');
     var cursorel = document.querySelector('#trainingplot .plotly .main-svg  .draglayer');
     cursorel.classList.add('cursor-default');
     cursorel.classList.remove('cursor-crosshair');
  };
</script>"))

#On model plots change
HTML(
  paste0("
<script>
  function include(url,id,fn){
     var e = document.createElement('script');
     e.onload = fn;
     e.id = id;
     e.src = url;
     e.async = true;
     document.getElementsByTagName('head')[0].appendChild(e);
  
  }
  
  function plotingtrainloss(data,xdata){
     var training = document.getElementById('trainingplot');
          
     Plotly.purge(training);
          
     var datalossplot = [{
       x: xdata,
       y: data,
       name: 'train loss'
    }];
          
    var layoutlossplot = {
       margin: {
         b: 40,
         l: 60,
         t: 25,
         r: 10 
       },
       xaxis:{
         tickformat: ',d',
         nticks: 10,
         showgrid: false,
         linecolor: 'black',
         ticks: 'outside'
       },
       yaxis: {
         domain: [0, 1],
         automargin: true,
         title: '',
         showgrid: false,
         linecolor: 'black',
         rangemode: 'normal',
         ticks: 'outside'
       },
       legend: {
         orientation: 'h',
         x: 0.40
       },
       hovermode: 'x unified',
       dragmode: true,
       showlegend: true
    };
          
    var config = {
        modeBarButtonsToRemove:['zoom2d','pan2d','select2d','lasso2d','zoomIn2d','zoomOut2d','autoScale2d','resetScale2d'],
        responsive: true
    }
          
    Plotly.plot(training, datalossplot, layoutlossplot, config);
    var cursorel = document.querySelector('#trainingplot .plotly .main-svg  .draglayer');
    cursorel.classList.add('cursor-default');
    cursorel.classList.remove('cursor-crosshair');
  }
  
  var predtrueval = ",predtrueval,";
  
  function plotingfirstrue(plot, x, y, name){
     var datatrueval = [{
                     x: x,
                     y: y,
                     name: name
                  }];
                  
      var layoutlossplot = {
                     margin: {
                       b: 40,
                       l: 60,
                       t: 25,
                       r: 10
                     },
                     xaxis:{
                       tickformat: ',d',
                       nticks: 10,
                       showgrid: true,
                       linecolor: 'black',
                       ticks: 'outside'
                     },
                     yaxis: {
                       domain: [0, 1],
                       automargin: true,
                       title: '',
                       showgrid: true,
                       linecolor: 'black',
                       rangemode: 'normal',
                       ticks: 'outside'
                     },
                     legend: {
                       orientation: 'v',
                       
                     },
                     hovermode: 'x unified',
                     dragmode: true,
                     showlegend: true
                  };
                  
                  var config = {
                  modeBarButtonsToRemove:['zoom2d','pan2d','select2d','lasso2d','zoomIn2d','zoomOut2d','autoScale2d','resetScale2d'],
                  responsive:true
                  }
                  
                  Plotly.plot(plot, datatrueval, layoutlossplot, config);
                  
  }

function tracesminmax(Date, data, colnames, col, predictionplot){
  var newtrace = [{
      x: Date,
      y: getCol(data,colnames[col] +'MIN'),
      legendgroup: colnames[col],
      mode:'lines',
      name: colnames[col]+'pred min'
  }];
  Plotly.addTraces(predictionplot,newtrace);
  var traces = document.querySelectorAll('#predictionsplot .plot .lines');
  var traces = traces[(traces.length-1)];
  var line = traces.children[0];
  var linecolor = line.style.stroke;
  var newtrace = [{
      x: Date,
      y: getCol(data,colnames[col]+'MAX'),
      legendgroup: colnames[col],
      mode: 'lines',
      fill: 'tonexty',
      name: colnames[col]+'pred max',
      line: {color: linecolor}
  }];
  Plotly.addTraces(predictionplot,newtrace);
  if(col == (colnames.length -1)){
    var cursorel = document.querySelector('#predictionsplot .plotly .main-svg  .draglayer');
    cursorel.classList.add('cursor-default');
    cursorel.classList.remove('cursor-crosshair'); 
  }
};

function PREDploting(data){
  var selectedrow = predtrueval[1];
  var colnames = Object.getOwnPropertyNames(selectedrow);
  var predictionplot = document.getElementById('predictionsplot');
  Plotly.purge(predictionplot);
  for(var col = 0; col < colnames.length; col++){
     if(colnames[col] == 'Date'){
         var Date = getCol(predtrueval,'Date');
     }else{
         if(col == 1){
             var y = getCol(predtrueval,colnames[col]);
             plotingfirstrue(predictionplot, Date, y, colnames[col]);
             tracesminmax(Date, data, colnames, col, predictionplot);
         }else{
             var newtrace = [{
                  x: Date,
                  y: getCol(predtrueval,colnames[col]),
                  name: colnames[col]
              }];
              Plotly.addTraces(predictionplot,newtrace);
              tracesminmax(Date, data, colnames, col, predictionplot);
         }
               
     }
  }
};

$(window).on('load',function(){
     
     var srcjs = './www/model_'+$('#plotmodelpick').val()+'/loss.json';
     include(srcjs, 'modelloss', function(){
          var data = JSON.parse(modellosses);
          var xdata = [];
          for(var i = 0; i < data.length; i++){
              var x = i+1;
              xdata.push(x);
          }
          
          plotingtrainloss(data,xdata);
          
     });
  });
  
$(window).on('load',function(){
     
     var srcjs = './www/model_'+$('#plotmodelpick').val()+'/mmmpred.json';
     include(srcjs,'modelpredic', function(){
          var predictionsdf = JSON.parse(modelpred);
          
          PREDploting(predictionsdf)
          
     })
  });
  
  $('#plotmodelpick').on('changed.bs.select',function(){
     
     var ele = $('#modelloss');
     ele.remove();
     var srcjs = './www/model_'+$('#plotmodelpick').val()+'/loss.json';
     include(srcjs, 'modelloss', function(){
          var data = JSON.parse(modellosses);
          var xdata = [];
          for(var i = 0; i < data.length; i++){
              var x = i+1;
              xdata.push(x);
          }
          
          plotingtrainloss(data,xdata);
     });
     
  });
  
  $('#plotmodelpick').on('changed.bs.select',function(){
    var ele = $('#modelpredic');
    ele.remove();
    var srcjs = './www/model_'+$('#plotmodelpick').val()+'/mmmpred.json';
     include(srcjs,'modelpredic', function(){
          var predictionsdf = JSON.parse(modelpred);
          
          PREDploting(predictionsdf)
          
     })
  })
  
</script>
  "
))

#Bar graph reactivity
HTML(paste0("
<script>
$('#modelpick').on('changed.bs.select',function(){
  ARROWS = 0;
  mydisablefunc('leftbut');
  myenablefunc('rightbut');
  var errors = ERRORS[0];
  var pickedmodels = $('#modelpick').val();
  var modelslosses = [];
  for(var models = 0; models < pickedmodels.length; models++){
    var model = 'model'+ pickedmodels[models];
    var ismodel = model in errors;
    if(ismodel == true){
      obj = {model : model, value: errors[model]}
      modelslosses.push(obj);
    }else{};
  };
  var amountofmodels = modelslosses.length;
  document.querySelector('#rangemodel').setAttribute('max',amountofmodels);
  document.querySelector('#maxvalue').innerHTML = amountofmodels;
  var modelrange = document.querySelector('#rangemodel');
  if(amountofmodels > modelrange.value){
  
  }else{
  
    if(amountofmodels < 5){
       modelrange.value = amountofmodels;
       mydisablefunc('leftbut');
       mydisablefunc('rightbut')
    }else{
       modelrange.value = 5;
       mydisablefunc('leftbut');
    }
  
  };
  document.querySelector('#actualvalue').innerHTML = modelrange.value;
  Plotly.purge('barchartloss');
  mybarplotlossfunc();
  var cursorel = document.querySelector('#barchartloss .plotly .main-svg  .draglayer');
  cursorel.classList.add('cursor-default');
  cursorel.classList.remove('cursor-crosshair');
});

$('#leftbut').on('click',function(){
  ARROWS = ARROWS - 1;
  if(ARROWS == 0){
    mydisablefunc('leftbut');
  };
  myenablefunc('rightbut');
  Plotly.purge('barchartloss');
  mybarplotlossfunc();
  var cursorel = document.querySelector('#barchartloss .plotly .main-svg  .draglayer');
  cursorel.classList.add('cursor-default');
  cursorel.classList.remove('cursor-crosshair');
});

$('#rightbut').on('click',function(){
  ARROWS = ARROWS + 1;
  var max = $('#rangemodel')[0];
  max = max.getAttribute('max');
  max = parseInt(max) - parseInt($('#rangemodel')[0].value);
  if(ARROWS == max){
    mydisablefunc('rightbut');
  };
  myenablefunc('leftbut');
  Plotly.purge('barchartloss');
  mybarplotlossfunc();
  var cursorel = document.querySelector('#barchartloss .plotly .main-svg  .draglayer');
  cursorel.classList.add('cursor-default');
  cursorel.classList.remove('cursor-crosshair');
});

$('#errorpick').on('change', function(){
  ARROWS = 0;
  mydisablefunc('leftbut');
  myenablefunc('rightbut');
  Plotly.purge('barchartloss');
  mybarplotlossfunc();
  var cursorel = document.querySelector('#barchartloss .plotly .main-svg  .draglayer');
  cursorel.classList.add('cursor-default');
  cursorel.classList.remove('cursor-crosshair');
});

$('#rangemodel').on('change', function(){
  ARROWS = 0;
  mydisablefunc('leftbut');
  myenablefunc('rightbut');
  var modelrange = $('#rangemodel')[0]
  var max = $('#rangemodel')[0].getAttribute('max');
  document.querySelector('#actualvalue').innerHTML = modelrange.value;
  if(modelrange.value == max){
    mydisablefunc('rightbut');
  }else{
    myenablefunc('leftbut');
  };
  Plotly.purge('barchartloss');
  mybarplotlossfunc();
  var cursorel = document.querySelector('#barchartloss .plotly .main-svg  .draglayer');
  cursorel.classList.add('cursor-default');
  cursorel.classList.remove('cursor-crosshair');
  
});

</script>
            "))

#Info icon 
HTML(paste0("
<script>
  
  function createtable(data){
    amountofrows = data.length;
    amountofcolumns = Object.keys(data[0]).length;
    var table = '<table><tbody>';
    for(rows = 0; rows < amountofrows; rows++){
       
       table = table + '<tr>';
       
       if(rows == 0){
          for(cols = 0; cols < amountofcolumns; cols++){
             table = table + '<th>' + Object.keys(data[rows])[cols] + '</th>';
          };
          table = table + '</tr><tr>';
       }else{};
       
       for(cols = 0; cols < amountofcolumns; cols++){
          var rdata = Object.values(data[rows]);
          table = table + '<td>' + rdata[cols] + '</td>';
       };
       
       table = table + '</tr>';
    };
    table = table + '</tbody></table>';
    return(table);
  }
  
  $(window).on('load',function(){
    var selectedrow = parseInt($('#plotmodelpick').val()) - 1;
    var arraytable = [];
    arraytable.push(datamodel[selectedrow]);
    var infotable = createtable(arraytable);
    var tablecontain = document.getElementById('containinginfot')
    tablecontain.innerHTML = infotable;
  });
  
  $('#plotmodelpick').on('changed.bs.select',function(){
    var selectedrow = parseInt($('#plotmodelpick').val()) - 1;
    var arraytable = [];
    arraytable.push(datamodel[selectedrow]);
    var infotable = createtable(arraytable);
    var tablecontain = document.getElementById('containinginfot')
    tablecontain.innerHTML = infotable;
  });
  
  $('#infoicon').mouseenter(function(){
    var module = document.getElementById('moduleinfo');
    module.style.display = 'inline-block';
  }).mouseleave(function(){
    var module = document.getElementById('moduleinfo');
    module.style.display = 'none';
  });
</script>

            "))

#Change between bargraph and table
HTML(paste0("
<script>
  $('#totable').on('click',function(){
     var plot = document.getElementById('resultsplot');
     plot.style.display = 'none';
     var table = document.getElementById('resultstable');
     table.style.display = 'flex';
  });
  $('#tochart').on('click',function(){
     var plot = document.getElementById('resultsplot');
     plot.style.display = 'flex';
     
     Plotly.purge('barchartloss');
     mybarplotlossfunc();
     
     var table = document.getElementById('resultstable');
     table.style.display = 'none';
  });
</script>"))

#Create table
HTML(paste0("
<script>

var TRANSPOND = 1;

function sortTable(n){
 if(TRANSPOND == 0){
   var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
   table = document.getElementById('TABLELOSS');
   switching = true;
   dir = 'asc';
   while(switching){
     switching = false;
     rows = table.rows;
     for(i = 1; i< (rows.length - 1); i++){
       shouldSwitch = false;
       x = rows[i].getElementsByTagName('TD')[n];
       y = rows[i + 1].getElementsByTagName('TD')[n];
       if(dir == 'asc'){
         if(n == 0){
           if(x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()){
             shouldSwitch = true;
             break;
           }
         }else{
           if(Number(x.innerHTML) > Number(y.innerHTML)){
              shouldSwitch = true;
              break;
           }
         }
       }else if(dir == 'desc'){
         if(n == 0){
           if(x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()){
             shouldSwitch = true;
             break;
           }
         }else{
           if(Number(x.innerHTML) < Number(y.innerHTML)){
              shouldSwitch = true;
              break;
           }
         }
       }
     }
     if(shouldSwitch){
       rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
       switching = true;
       switchcount = true;
     }else{
       if(switchcount == 0 && dir == 'asc'){
         dir = 'desc';
         switching = true;
       }
     }
   }
 }else{
   var table, cols, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
   table = document.getElementById('TABLELOSS');
   switching = true;
   dir = 'asc';
   while(switching){
     switching = false;
     rows = table.rows;
     for(i = 1; i< (rows[0].cells.length - 1); i++){
       shouldSwitch = false;
       x = rows[n].cells[i];
       y = rows[n].cells[i + 1];
       if(dir == 'asc'){
         if(n == 0){
           if(x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()){
             shouldSwitch = true;
             break;
           }
         }else{
           if(Number(x.innerHTML) > Number(y.innerHTML)){
              shouldSwitch = true;
              break;
           }
         }
       }else if(dir == 'desc'){
         if(n == 0){
           if(x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()){
             shouldSwitch = true;
             break;
           }
         }else{
           if(Number(x.innerHTML) < Number(y.innerHTML)){
              shouldSwitch = true;
              break;
           }
         }
       }
     }
     if(shouldSwitch){
       for(r = 0; r< rows.length; r++){
          rows[r].cells[i].parentNode.insertBefore(rows[r].cells[i + 1],rows[r].cells[i]);
       switching = true;
       switchcount = true;
       }
       
     }else{
       if(switchcount == 0 && dir == 'asc'){
         dir = 'desc';
         switching = true;
       }
     }
   }
 }
};

function resultstable(){
   var errors = ERRORS[1];
   var pickedmodels = $('#modelpick').val();
   var modelslosses = [];
   for(var models = 0; models < pickedmodels.length; models++){
      var model = 'model'+ pickedmodels[models];
      var ismodel = model in errors;
      if(ismodel == true){
        obj = {Models : model, MSE: ERRORS[0][model], RMSE: ERRORS[1][model], MAE: ERRORS[2][model]};
        modelslosses.push(obj);
      }else{};
    };
    modelslosses = modelslosses.map(Object.values);
    modelslosses.unshift(['Models','MSE','RMSE','MAE']);
    if(TRANSPOND == 1){
      modelslosses = modelslosses[0].map((col,i) => modelslosses.map(row => row[i]));
    }else{};
    
    var amountr = modelslosses.length;
    var amountc = modelslosses[0].length;
    var table = '<table><tbody>';
    
    if(TRANSPOND == 1){
      for(var rows = 0; rows < amountr; rows++){
       
       table = table + '<tr>';
       for(var cols = 0; cols < amountc; cols++){
          
          if(cols == 0){
            table = table + '<th onclick = \"sortTable('+rows+')\">'+modelslosses[rows][cols]+'</th>';
          }else{
            table = table + '<td>'+modelslosses[rows][cols]+'</td>';
          };
          
       };
       table = table + '</tr>';
      };
    }else{
      for(var rows = 0; rows < amountr; rows++){
       
       table = table + '<tr>';
       if(rows == 0){
         for(var cols = 0; cols < amountc; cols++){
          
          table = table + '<th onclick = \"sortTable('+cols+')\">'+modelslosses[rows][cols]+'</th>';
          
         };
       }else{
         for(var cols = 0; cols < amountc; cols++){
          
          table = table + '<td>'+modelslosses[rows][cols]+'</td>';
          
         };
       }
       
       table = table + '</tr>';
      };
      
    }
    
    
    table = table + '</tbody></table>';
    var addtable = document.getElementById('lossestable');
    addtable.innerHTML = table;
    var gettable = document.querySelector('#lossestable > table');
    gettable.setAttribute('id','TABLELOSS');
};

$(window).on('load',function(){
  resultstable();
  sortTable(2)
});

$('#transpondtable').on('click', function(){
  if(TRANSPOND == 1){
    TRANSPOND = 0;
  }else{
    TRANSPOND = 1;
  };
  resultstable();
  sortTable(2)
});

$('#modelpick').on('changed.bs.select',function(){
  resultstable();
  sortTable(2);
})

</script>
            "))

#On collaps button
HTML(paste0("
<script>
var COLLAPSE = 0
$('#collapseSB').on('click',function(){
  if(COLLAPSE == 0){
    var actheight = document.getElementById('containingfilters').offsetHeight;
    document.getElementById('containingfilters').style.display = 'none';
    document.getElementById('emptydiv').style.height = actheight+'px';
    document.getElementById('SBchild').parentElement.parentElement.style.width = '10%';
    document.getElementById('pickmlcontain').parentElement.parentElement.parentElement.style.width = '89%';
    Plotly.redraw('trainingplot');
    document.getElementById('collapseSB').classList.add('fa-caret-square-o-right');
    document.getElementById('collapseSB').classList.remove('fa-caret-square-o-left');
    COLLAPSE =  1
  }else{
    document.getElementById('containingfilters').style.display = 'block';
    document.getElementById('emptydiv').style.height = '0px';
    document.getElementById('SBchild').parentElement.parentElement.style.width = '33%';
    document.getElementById('pickmlcontain').parentElement.parentElement.parentElement.style.width = '66%';
    Plotly.redraw('trainingplot');
    document.getElementById('collapseSB').classList.add('fa-caret-square-o-left');
    document.getElementById('collapseSB').classList.remove('fa-caret-square-o-right');
    COLLAPSE = 0
  }
  
});
</script>
            "))
```
